---
author: ""
date: ""
title: ""
output:
  html_document:
    toc: false
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(
  # echo = TRUE,
  echo = FALSE,
  # cache = TRUE,
  # include = FALSE,
  # results = "markdown",
  # results = "hide",
  fig.align = "center",
  # fig.show = "asis",
  fig.width = 10,
  fig.height = 10,
  # out.width = 6,
  # out.height = 6,
  warning = FALSE,
  message = FALSE
)

```

```{r load, include = FALSE}
source(file.path("R", "00-config.R"))
# load(params$path_analysis_image)
# schools <-
#   params$path_schools_clean %>%
#   teproj::import_path_cleanly()

persons <-
  params$path_persons_clean %>%
  teproj::import_path_cleanly()

```

## Individual Participation

To begin, let's take a closer look at individual competitors. Which individuals
have competed the most?

```{r person_n_top, include = FALSE}
persons_n <-
  persons %>%
  group_by(name, school, conf) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  rank_arrange_at(col = "n")
persons_n

html_persons_n_top <-
  persons_n %>%
  create_kable_filt_at(
    params = params,
    col_rgx = "name",
  )
```

```{r html_person_n_top, echo = FALSE, include = TRUE}
html_person_n_top
```

Although the names here may not provide much insight, the counts provide some context
regarding the limits of individual participation.

Given that individual participation may not be indicative of anything directly,
it may be a better idea to break it down by conference. What is the count
of unique individuals competing in each conference?

```{r person_n_top_byconf, include = FALSE}
# n_top_conf <- 10000
n_top_conf <- nrow(persons_n)
persons_n_top_byconf <-
  persons_n %>%
  slice(1:n_top_conf) %>%
  group_by(conf) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  rank_arrange_at(col = "n")
persons_n_top_byconf

html_persons_n_top_byconf <-
  persons_n_top_byconf %>%
  mutate_at(vars(n), funs(scales::comma)) %>%
  teproj::create_kable()

```

```{r html_person_n_top_byconf, echo = FALSE, include = TRUE}
html_person_n_top_byconf
```

It seems that there are not as many individual competitors in the 6A conference (`conf 6`).
This seems to be true even when stratifying the individuals into groups of ranks (by
volume of individual participation).

```{r viz_persons_n_top_byconf, include = TRUE, fig.show = "asis"}
viz_persons_n_top_byconf <-
  persons_n %>%
  mutate(
    rnk_tier_lab =
      case_when(
        rnk <= 1000L ~ "Top 1k",
        rnk <= 10000L ~ "Top 10k",
        rnk <= 100000L ~ "Top 100k",
        TRUE ~ "Outside top 100k"
      )
  ) %>%
  mutate_at(vars(rnk_tier_lab), funs(forcats::fct_rev(factor(.)))) %>%
  ggplot(aes(x = conf, y = n, alpha = rnk_tier_lab)) +
  geom_col() +
  teplot::scale_y_pretty_comma() +
  teplot::theme_te_dx() +
  teplot::labs_xy_null() +
  labs(title = "Count of Unique Competitors for Each Conference",
       caption = "\"Tier\" of individuals ranked by count of competitions is emphasized by shading.")
viz_persons_n_top_byconf
teproj::export_ext_png(
  viz_persons_n_top_byconf,
  export = params$export_viz,
  dir = params$dir_viz,
  units = "in",
  height = 6,
  width = 8
)
```

I would hypothesize that the noticeable lack of individual competitors in conference 6A--
which is the conference with largest high schools (according to student body size)--
can be attributed to "allocation of talent" by these schools.
In other words, these schools may be more likely to designate their individual
competitors to compete in only specific competitions.
By comparison, schools in the other conferences may be more willing to let individual
students to compete in as many competition types as they desire, even if they have
not prepared for them whatsoever.

Along these lines, note that there is a limit on the number of entrants
per school in a given competition. This means that smaller schools are much less likely to
have enough people to reach the per-school limit, so individuals at these schools
are welcome to compete in as many competitions as they would like.

Such a phenomenon might be evident in lower scores (in aggregate) for conferences where participation
by distinct individuals is greater. In fact, this is exactly what is observed.
(The below visual was included as part of another visual before.)

```{r viz_persons_n_top_byconf}
viz_persons_stats_bycompconf
```


```{r}
persons_stats <-
  persons %>%
  add_persons_stats_cols_by_at()

persons_stats %>% count(n_advanced) %>% arrange(desc(n_advanced))
persons_stats %>% count(n_state) %>% arrange(desc(n_state))

html_persons_stats_filt <-
  persons_stats %>%
  select(-n_advanced, -n_state) %>%
  create_kable_filt_at(
    params = params,
    col_rgx = "name",
  )

```



## Invidual Performance

Now, I want to try to answer a somewhat ambiguous question:
Which individuals were most "dominant"?

### Evaluating "Dominance"

Because the term "dominance" is faily subjective, it must be defined explicilty.
Here is my definition/methodology, along with some explanation.

First, I assign a percent rank to individual placings in all
competitions based on score relative to other scores in that competition. 
I choose to use percent rank--which is a always a value between 0 and 1--because
it inherently accounts for the
wide range of number of competittors across all competitions. 
For this context, a percent rank of 1 corresponds to the highest score in a given
competition (for each unique year, competition type, and competition level), and, conversely,
a value of 0 corresponds to the lowest score.

I should note that I evaluated some other metrics for gauging individual
success, including the total number
of individuals defeated in competitions (i.e. "defeats"). 
Percent rank based on score and number of defeats attempt to quantify the same underlying variable,
but I think percent rank is a little more "natural" to interpret because
it contextualizes number of competitors with its unit range (i.e. range from 0 to 1).
By comparison, interpretation of number of defeats is less direct because
the number of other competitors is not accounted directly.

To generate a final set of ranks, one for each unique competitor,
based on the percent ranks for individual competitions,
I simply sum up the percent ranks for each individual.

The sum is used instead of an average--which may also be considered a valid
means of aggregating the values for each individual--because rankings based on averages
--and inferences made upon them--are sensitive
to individuals who do not compete in many competitions, yet place very well in them.
A final ranking based on a summed value does not suffer from this pitfall,
although it can be sensitive to the sample size of each participant. (i.e. 
An individual might partipate in a high number of competitions and
under-perform relative to the average in all of them, yet their final ranking
(based on summed percent ranks) might indicate that they are an above-average performer.)

```{r persons_rnks, include = FALSE}
add_rnks_cols_by_at <-
  function(data = NULL,
           col = NULL,
           cols_grp = c("name", "school", "conf")) {
    stopifnot(is.character(col), length(col) == 1, length(intersect(names(data), col)) == 1)
    stopifnot(is.character(cols_grp),
              length(intersect(names(data), cols_grp)) == length(cols_grp))
    data %>%
      group_by(!!!syms(cols_grp)) %>%
      summarise_at(vars(!!sym(col)), funs(sum, mean)) %>%
      ungroup() %>%
      mutate(rnk_sum = row_number(desc(sum)),
             rnk_mean = row_number(desc(mean))) %>% 
      arrange(rnk_sum, rnk_mean)
  }

persons_rnks <-
  left_join(
    persons %>%
      add_rnks_cols_by_at("prnk"),
    persons %>%
      add_rnks_cols_by_at("n_defeat") ,
    by = c("name", "school", "conf"),
    suffix = c("_prnk", "n_defeat")
  )

html_person_rnks <-
  persons_rnks %>%
  create_kable()
```

```{r html_person_rnks, echo = FALSE, include = TRUE}
html_person_rnks
```

Some of the same individuals from the participation-based ranking
of competitors also appear among the top of the ranks by my evaluation of domination.
This is somewhat expected due to the nature of my methodology (in particular, my
choice to use a sum instead of an average or some other statistic).
Certaintly some additional statistical analysis could be done here to investigate
other methods of quantifying dominance (beyond even some of my off-line analysis), 
but I'll leave that for another time.
Because there is no well-agreed upon metric or method anywhere for quantifying
dominance for this particular topic, it's difficult to really judge the findings here.

In any matter, the difference between the ranks based on the average and the sum
of percent ranks is not all too great--I found that the correlation between the
two is about 0.85. (This value is nearly the same when using the number of defeats
as the metric for ranking.)

```{r persons_rnks_cors, include = FALSE}
correlate_rnks_at <-
  function(data = NULL, cols = str_subset(names(data), "^rnk_")) {
    data %>%
      select(one_of(c(cols))) %>%
      corrr::correlate()
  }
persons_rnks_cors <-
  persons_rnks %>% 
  select(starts_with("rnk")) %>%
  corrr::correlate()

html_persons_rnks_cors <-
  persons_rnks_cors %>%
  create_kable()
```

```{r html_persons_rnks_cors, echo = FALSE, include = TRUE}
html_persons_rnks_cors
```

### Evaluating "Carrying"

Another way of identifying superb ability is to compare the scores of individuals
with those of their teammates. Individuals with high schores relative to 
their teammates might be said to have "carried" their teammates.
Although this kind of evaluation is dependent on the skill of each team
independent of the competition setting, I think that it is another interesting way of
evaluating skill.

```{r persons_stats_byschool, include = FALSE}

n_ingroup_min <- 3
persons_stats_byschool <-
  persons %>%
  # filter(school == params$rgx_school_filt, year <= 2012, year >= 2011) %>%
  group_by(comp, complvl, conf, year, school) %>%
  mutate(n_ingroup = n()) %>%
  filter(n_ingroup >= n_ingroup_min) %>%
  mutate(ingroup_rnk = row_number(desc(score))) %>%
  mutate(ingroup_score_other = (sum(score) - score)  / (n_ingroup - 1)) %>%
  mutate(ingroup_diff = score - ingroup_score_other) %>%
  ungroup() %>%
  mutate(among_group_rnk = row_number(desc(ingroup_diff))) %>%
  arrange(among_group_rnk)
persons_stats_byschool
```

```{r viz_comp_stats_byperson_byschool, include = FALSE, fig.show = "asis"}
set.seed(42)
pct_top_ingroup_diff_prnk <- 0.05
viz_comp_stats_byperson_byschool <-
  persons_stats_byschool %>%
  mutate(ingroup_diff_prnk = percent_rank(ingroup_diff)) %>%
  mutate(ingroup_diff_toppct = if_else(ingroup_diff_prnk >= (1 - pct_top_ingroup_diff_prnk), T, F)) %>%
  sample_frac(size = 0.05) %>%
  # ggplot(aes(x = score, y = group_score)) +
  ggplot(aes(x = score, y = ingroup_score_other)) +
  geom_point(aes(color = ingroup_diff_toppct), alpha = 0.1) +
  geom_point(
    data =
      persons_stats_byschool %>%
      filter(str_detect(name, params$rgx_name_filt)),
    aes(x = score, y = ingroup_score_other),
    color = "blue",
    size = 5,
    shape = 18
  ) +
  scale_color_manual(values = c("black", "red")) +
  geom_abline(
    aes(intercept = 0, slope = 1),
    color = "black",
    linetype = "solid",
    size = 2
  ) +
  geom_abline(
    aes(
      intercept = -quantile(ingroup_diff, 1 - pct_top_ingroup_diff_prnk, na.rm = T),
      slope = 1
    ),
    color = "red",
    size = 1,
    linetype = "dashed"
  ) +
  labs(
    x = "Individual Score",
    y = "Average Score of Teammates",
    title = "Distribution of Individual and Teammate Scores",
    caption =
      str_wrap(
        paste0(
          "Blue points highlight my personal scores. ",
          sprintf("Red emphasizes top %.0f%% of individuals who \"carried\" ", 
                  100 * pct_top_ingroup_diff_prnk),
          "their teammates, according to differences in percent rank ",
          "of difference in individual score and average of teammates scores. ",
          "Only unique school-competitions observations having",
          sprintf("at least %.0f team members are considered.", n_ingroup_min)
        ), 100
      )
  ) +
  teplot::theme_te_facet() +
  theme(legend.position = "none")
viz_comp_stats_byperson_byschool
```




