---
author: ""
date: ""
title: ""
output:
  html_document:
    toc: false
---

```{r setup, echo = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(
  # echo = TRUE,
  echo = FALSE,
  # cache = TRUE,
  include = FALSE,
  # results = "markdown",
  results = "hide",
  fig.align = "center",
  # fig.show = "asis",
  fig.width = 6,
  fig.height = 6,
  # out.width = 6,
  # out.height = 6,
  warning = FALSE,
  message = FALSE
)

```

```{r params}
params <-
  list(
    dir_data = "data",
    export_data = FALSE,
    dir_viz = "figs",
    export_viz = FALSE,
    path_geo_raw = file.path("data-raw", "EDGE_GEOCODE_PUBLICSCH_1516.xlsx"),
    path_schools = "O:/_other/projects/uil/data/schools-clean.csv"
  )
```


```{r packages}
library("dplyr")
library("ggplot2")
library("tidyr")
library("teplot")
```

```{r setup_vars_funcs}
# theme_base <- function() {
#   teplot::theme_te_b_facet(
#     base_size = 12,
#     plot_title_size = 16,
#     subtitle_size = 12,
#     axis_title_size = 12,
#     caption_face = "plain",
#     caption_size = 12,
#     plot_margin = ggplot2::margin(2, 2, 2, 2)
#   ) +
#   ggplot2::theme(
#     legend.text = ggplot2::element_text(size = 12)
#   )
# }
# theme_base <- teplot::theme_te()

create_kable <-
  function(data = NULL, num_show = 10) {
    
    num_rows <- nrow(data)
    show_fn <- ifelse(num_rows > num_show, TRUE, FALSE)
    if(show_fn) {
      data <- data %>% dplyr::slice(1:num_show)
    }
    
    ret <-
      data %>% 
      knitr::kable( "html", escape = FALSE) %>%
      kableExtra::kable_styling(full_width = FALSE, position = "center")
    
    if(show_fn) {
      ret <-
        ret %>%
        kableExtra::add_footnote(c(sprintf("# of total rows: %.0f", num_rows)), notation = "number")
    }
    ret
  }
import_cleanly <-
  function(path = NULL) {
    path %>%
      rio::import() %>%
      tibble::as_tibble() %>% 
      janitor::clean_names()
  }

arrange_distinctly <- function(data, ...) {
  cols <- rlang::enquos(...)
  data %>%
    arrange(!!!cols) %>%
    distinct(!!!cols)
}
```

```{r schools_geo}
schools_geo <-
  params$path_schools_geo_clean %>% 
  import_cleanly()

```

```{r viz_map_bycnts}
viz_map_base <-
  teplot::create_map_state(state = "texas", show_county = FALSE) +
  teplot::theme_te() +
  teplot::theme_te_map()

viz_map_bycnts <-
  viz_map_base +
  geom_polygon(
    data = schools_geo %>%
      count(state, county) %>%
      inner_join(
        get_map_data_county_tx(),
        by = c("county" = "subregion")
      ),
    aes(fill = n)
  ) +
  scale_fill_gradient(
    trans = "log",
    low = "white",
    high = "red"
  ) +
  theme(legend.position = "none")
viz_map_bycnts
```

```{r viz_map_bycnts_2, eval = FALSE}
viz_map_bycnts_2 <-
  viz_map_base +
  geom_point(
    data = schools_geo,
    aes(x = lon, y = lat, group = county, alpha = 0.1),
    shape = 20,
    color = "red",
    size = 1
  ) +
  theme(legend.position = "none")
viz_map_bycnts_2
```

```{r schools_geo}

```

```{r schools_geo_debug, include = FALSE}

```

```{r}
schools_geo_bydistrict_viz <-
  schools_geo_bydistrict %>%
  mutate_at(vars(complvl_num), funs(factor)) %>% 
  inner_join(
    teplot::get_map_data_county_tx(),
    by = c("county" = "subregion")
  )
viz_map_bydistrict <-
  viz_map_base +
  geom_polygon(
    data = schools_geo_bydistrict_viz,
    aes(group = county, fill = complvl_num),
  ) +
  viridis::scale_fill_viridis(
    discrete = T,
    option = "D",
    guide = guide_legend(title = "District", nrow = 4, byrow = T)
  ) +
  theme(
    legend.position = "bottom"
  )
viz_map_bydistrict
```


```{r eval = FALSE}
viz_map_bydistrict <-
  viz_map_base +
  geom_point(
    data = schools_geo_bydistrict,
    aes(x = lon, y = lat, group = county, color = complvl_num),
    shape = 20,
    size = 1
  ) +
  # scale_alpha(guide = "none") +
  scale_color_discrete(
    guide = 
      guide_legend(title = "District", 
                   nrow = 4, 
                   byrow = T, 
                   override.aes = list(size = 5))
  ) +
  theme(
    legend.position = "bottom"
  )
viz_map_bydistrict
```

